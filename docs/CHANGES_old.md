# Changelog

Look for new version on [https://github.com/justtopich/](https://github.com/justtopich/)

<u>Development and support has stopped.</u> For another data collector with same functionality written on Python, see **Lootnika** data collector.



## 2020.05.22

### Improvements

* refactoring
* change MySQL library mysql-connector -> mysql-connector-python
* Tasks logging separately
* Not ingested documents will saved in subfolders like `task_date/task_name`
* xmlPath have default value `ingest_failed`
* renamed parameters in [ingest] section

### Fixed

* Doesn't save XML documents if can't connect to ingesting host

* Connector may not to stop if checking TCP port not passed on starting

  

## 2020.05.19
### Features

* console key *doc* for export documentation

### Improvements

* причёсана структура проекта. Удалён мусор из истории git



## 2019.07.23
### Improvements
* Добавлена поддержка метода POST для команды View



## 2019.07.03
### Improvements
* изменён метод остановки REST сервера - вместо флага запроса остановки проверяется флаг работы сервера.

### Fixed
* Не всегда корректно определял рабочую папку в версии exe. Из-за этого мог не стартовать как служба. В windows server 2012 иначе задаётся рабочая папка. Добавлены методы для 2012 и остальных windows
* изменения в парсере конфига - убрана чувствительность к регистру в названиях секций
* Команда на старт конкретного задания запускала все активные из расписания



## 2018.09.25
###  Features
* Добавлено название задания в заголовки логеров
* В логах теперь пишется название файла с которым будет выполнен экспорт
* В логах выполнения задания теперь будут писаться названия этих заданий
* В логах пишет названия файлов с которыми они будут скачаны

### Improvements
* расширены случаи записи в поле _error. Теперь таких полей может быть несколько на каждую ошибку.
* add more stackTrace for exceptions in Developer mode
* Обработка бага офф. библиотеки MySQL: MySQLCursor Bug #64392
* Изменения подсчёта контрольный сумм документов: теперь учитывает названия полей.

### Fixed
* В прошлой версии было сломано выполнение заданий по команде если выключено расписание
* не завершает выполнение задания при отправки команды стоп.
* next_task_start был в next_start_time
* не выполнял команду stop если запущен как служба
* Нельзя было установить службу если в загрузчике задания указана сетевая папка
* Если в настройках [Schedule] указать enable = false,  taskcount = 0, команда на выполнение задания могла привести к ошибке в работе планировщика заданий при повторном вызове этой команды
* мелкие исправления справки



## 2018.08.30
###  Features
* в QueueInfo добавлены поля scheduler_status, next_task_start, remained_cycles

### Improvements
* метод завершения работы вызывается теперь один раз, сколько бы команд не пришло. Ни на что не влияло.

### Fixed
* в getstatus не было команды grl для роли admin
* исправлен отсчёт времени следующего старта: с build20180808 repeatmin указывал часы а не минуты



## 2018.08.29
###  Features
* добавлена команда GetStatus

### Fixed
* Забыл добавить безопасную остановку, когда коннектор запущен как служба
* исправлена проверка доступа: если в роли указать * то коннектор запрещал вход



## 2018.08.08
###  Features
* в случае если коннектор не смог запустить даже основные модули, то в исполняемой папке будет создан error.txt с  описанием ошибки

### Improvements
* Улучшена проверка свободного TCP порта
* Расчёт времени старта заданий теперь выполняется по локальному времени сервера. Раньше использовался собственный таймер  что могло приводить к накапливанию ошибки.
* переделан и исправлен вывод запросов GRL. Фильтр сохраняет свой статус
* запросы статичных файлов теперь не отслеживаются в GRL
* при запуске всем незавершённым заданиям (run, pause) присваивается статус fail
* отменённым заданиям присваивается статус cancel в журнале заданий

### Fixed
* Коннектор не мог использовать 7z когда работал как служба.
* Устранён запуск задания по расписанию если команда уже выполняется. Если отправить команду startTask сразу после старта коннектора перед тем как стартуют задания при опции taskStartTime = now, то выполняться будут оба одновременно



## 2018.08.02
###  Features
* проверка занятости порта для http сервера. При дебаге и его занятости выведет стату команды netstat -anop
* сделана безопасная остановка коннектора. Написан специальный метод который в нужном порядке завершает потоки.
  Сначала http сервер, потом задания, потом БД коннектора. Так коннектор отправит все документы что успел собрать и запишет статус в журнал заданий. Когда все операции с БД завершены - коннектор прекращает работать.
* Написан метод контроля целостности коннектора. Он следит за работой ключевых модулей и необходим при  завершении работы в случае если один из них упал или не стартанул при запуске коннектора.
* Дописаны модули для исполнения команд планировщика (stop, start, pause и т.д.)
* Добавлена роль админа в разграничение доступа. Адреса вносятся в параметр AdminClients
* Наконец доделаны команды управления заданиями: start, pause, cancel.

### Improvements
* документ заносится в журнал задания только после того, как коннектор смог его получить, а не перед его запросом.
* для создания токенов теперь используется более безопасная библиотека secrets



## 2018.07.18
###  Features
* При выполнении нескольких заданий xml будет записан в папку sendFail предыдущего задания
* левое меню WebUI подстраивается под изменение окна

### Improvements
* Файлы WebUI перенесены из папки admin в webui. В ней две папки с двумя UI: Admin & Help.
* изменение роутинга WebUI

### Fixed
* теперь левое меню WebUI имеет постоянный размер и не уходит за экран при position:fixed (когда видно верхнее меню).



## 2018.07.12
### Improvements
* оптимизация в коде в модуле conf

### Fixed
* При не удачном экспорте в xml не всегда был вывод ошибки
* При создании отсутствующей секции коннектор не находил параметры из конфига с буквами большого регистра и нужен был  перезапуск.



## 2018.07.11
### Improvements
* Дополнительный чекпоинт задания при получении количества доков для отрисовки прогрессбара в админке.
* Изменено логирование старта и окончания цикла заданий. При выполнении задания через команды коннектор теперь рапартует только о старте и завершении самого задания.
* В конфиге перенесён параметр xmlPath из секции Server в Ingest

### Fixed
* При выполнении команды tasksinfo заменяются значения паролей и логинов на \*. Но после этой команды заменялись значения не только в копии списка заданий, но и в оригинале. Это приводило к ошибке выполнении заданий после этой команды. 
  Копия задания теперь создаётся при запуске коннектора, а не каждый раз при выполнении команды tasksinfo.
* Исправлено выполнение запросов selectComplete. Например, если в запросе присутствует LIMIT, т.к. сам коннектор  дописывает LIMIT и OFFSET к запросам. Теперь они оригинальный запрос вносится в ()



## 2018.04.17
###  Features
* новый параметр selectСomplete который заменяет selectId и selectMeta. На случай если все документы можно получить одним запросом.
* Добавил в базу count_total чтобы можно было следить за процентом выполнения задания.



## 2018.03.27
###  Features
* новый параметр docRef
* новый параметр NotNullRows

### Improvements
* Переименован параметр SendFail -> xmlPath
* Переименован параметр SelectMeta -> SelectMeta0
* Переименован переменная @id -> @id_range



## 2018.03.16
### Improvements
* PathFiles переехали в Downloader
* FailDwnld переехали в Downloader
* repeattime -> taskCycles
* repeattime -> repeatMin
* downloader -> getfiles
* downloader теперь является ссылкой



## 2018.02.20
###  Features
* инсталятор либ из zip (a так же tar.bz2; tar.xz; tar.gz)
* сделана страничка GRL
* расписание заданий
* Синхронная очередь выполнения запросов в SQLlite из разных потоков, с получением их статуса выполнения

### Improvements
* SendFail теперь содержит папки вида <задание\_uuid> чтобы было проще ориентироваться
* в SendFail сохраняются не только xml но и **deleteRef.txt** с командами на удаление
* Отдельный журнал на все задания, с их статистикой и статусом
* TraceBack теперь есть только при [logging]loglevel=full

### Fixed
* Наконец поправил багу с авторефрешем страницы grl + реализовал лимит записей



## 2017.12.01
###  Features
* Теперь можно создать службу и запускать через неё. Запуск в консоли сохранён. Появилась секция [service]

### Improvements
* SelectID теперь без @id_range@ и берёт сразу все id. Да, кучу записей может повесить базу или отожрать память зато можно написать любой запрос для получения id.
* Переименован параметр critFree -> critFreeGb
* Переименован параметр starttask -> enable
